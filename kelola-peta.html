<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kelola Peta & Jangkauan - Admin</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{--primary:#003366;--secondary:#006699;--accent:#ffd000}
body{display:flex;min-height:100vh;font-family:'Segoe UI',sans-serif;background:#f2f6fc;}
.sidebar{width:260px;background:var(--primary);color:#fff;position:fixed;padding:24px;height:100vh}
.sidebar h2{font-size:22px;margin-bottom:18px}
.sidebar ul{list-style:none;padding:0}
.sidebar ul li{padding:10px;border-radius:6px;margin-bottom:8px;cursor:pointer}
.sidebar ul li.active, .sidebar ul li:hover{background:var(--secondary)}
.content{margin-left:260px;padding:28px;flex:1}
.card-box{background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.table td, .table th{vertical-align:middle}
.small-help{font-size:.9rem;color:#666;margin-top:6px}
.preview-iframe{width:100%;height:320px;border:1px solid #ddd;border-radius:6px;overflow:hidden}
.controls-row{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>Admin Panel</h2>
  <ul>
    <li onclick="location.href='dashboard.html'"><i class="fa fa-gauge me-2"></i> Dashboard</li>
    <li onclick="location.href='kelola-paket.html'"><i class="fa fa-wifi me-2"></i> Kelola Paket</li>
    <li onclick="location.href='kelola-testimoni.html'"><i class="fa fa-comment me-2"></i> Kelola Testimoni</li>
    <li onclick="location.href='kelola-pesan.html'"><i class="fa fa-envelope me-2"></i> Pesan Kontak</li>
    <li class="active"><i class="fa fa-map me-2"></i> Kelola Peta</li>
    <li onclick="location.href='pengaturan-web.html'"><i class="fa fa-gear me-2"></i> Pengaturan</li>
  </ul>
  <button class="btn" style="margin-top:18px;background:var(--accent);color:#003366;width:100%;font-weight:700" onclick="location.href='admin-login.html'">Logout</button>
</div>

<!-- Content -->
<div class="content">
  <h1 class="mb-2">Kelola Peta & Jangkauan Layanan</h1>
  <p class="small-help">Tambah lokasi jangkauan. Untuk setiap lokasi, masukkan Nama Lokasi dan *Embed Code* (iframe) atau URL Google Maps. Data disimpan sementara di browser (localStorage).</p>

  <div class="card-box mt-3 mb-3">
    <h5>Tambah / Edit Lokasi</h5>

    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Nama Lokasi</label>
        <input id="lokasiNama" class="form-control" placeholder="Contoh: Pangandaran" />
      </div>

      <div class="col-md-8">
        <label class="form-label">Embed Iframe (direkomendasikan) <span class="text-muted">â€” atau masukkan Google Maps URL</span></label>
        <input id="lokasiEmbed" class="form-control" placeholder='Contoh: &lt;iframe src="..."&gt;&lt;/iframe&gt;  atau https://goo.gl/maps/...' />
        <div class="small-help">Jika memasukkan URL Google Maps, sistem akan mengubahnya menjadi iframe saat tampil di publik.</div>
      </div>

      <div class="col-12 mt-2 controls-row">
        <button id="btnSimpan" class="btn btn-success"><i class="fa fa-save me-1"></i> Simpan Lokasi</button>
        <button id="btnBersihkan" class="btn btn-outline-secondary">Bersihkan Form</button>
        <button id="btnExport" class="btn btn-outline-info"><i class="fa fa-file-export me-1"></i> Export JSON</button>
        <input type="file" id="fileImport" accept=".json" style="display:none"/>
        <button id="btnImport" class="btn btn-outline-primary"><i class="fa fa-file-import me-1"></i> Import JSON</button>
      </div>
    </div>

    <div class="mt-3">
      <label class="form-label">Preview iframe (jika valid)</label>
      <div id="previewArea" class="preview-iframe bg-light d-flex justify-content-center align-items-center">
        <small class="text-muted">Tidak ada preview</small>
      </div>
    </div>
  </div>

  <div class="card-box">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="m-0">Daftar Lokasi</h5>
      <small class="text-muted">Total: <span id="totalLokasi">0</span></small>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-light">
          <tr>
            <th width="50">#</th>
            <th>Nama Lokasi</th>
            <th>Preview</th>
            <th width="180">Aksi</th>
          </tr>
        </thead>
        <tbody id="listLokasi"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/*
 Struktur data di localStorage:
 localStorage['afnalink_maps'] = JSON.stringify([
   { id: 'uuid', name: 'Pangandaran', embed: '<iframe ...></iframe>' , created: 166... }
 ])
*/

const STORAGE_KEY = "afnalink_maps";

function uid() {
  return 'id-' + Math.random().toString(36).slice(2,9);
}

function getMaps() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch(e) {
    return [];
  }
}

function saveMaps(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

/* Render list */
function renderList() {
  const arr = getMaps();
  const tbody = document.getElementById("listLokasi");
  tbody.innerHTML = "";
  arr.forEach((m, i) => {
    const previewShort = makeSafePreview(m.embed);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(m.name)}</td>
      <td style="min-width:240px">${previewShort}</td>
      <td>
        <button class="btn btn-sm btn-primary me-1" onclick="useOnPublic('${m.id}')"><i class="fa fa-eye me-1"></i> Tampilkan</button>
        <button class="btn btn-sm btn-warning me-1" onclick="editItem('${m.id}')"><i class="fa fa-edit me-1"></i> Edit</button>
        <button class="btn btn-sm btn-danger" onclick="hapusItem('${m.id}')"><i class="fa fa-trash me-1"></i> Hapus</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("totalLokasi").textContent = arr.length;
}

/* sanitize / safe preview: jika ada iframe tunjukkan icon, jika URL tunjukkan link */
function makeSafePreview(embed) {
  if(!embed) return '<small class="text-muted">-</small>';
  // if contains <iframe
  if(/<iframe/i.test(embed)) {
    return '<small class="text-success"><i class="fa fa-map me-1"></i>Embed</small>';
  }
  // if looks like URL
  if(/https?:\/\//i.test(embed)) {
    return `<a href="${escapeAttr(embed)}" target="_blank" rel="noopener" class="small">Buka Map</a>`;
  }
  return '<small class="text-muted">Tidak dikenali</small>';
}

/* escape helpers */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s){ return s.replaceAll('"','&quot;'); }

/* Actions: simpan / edit / hapus */
let editingId = null;

document.getElementById("btnSimpan").addEventListener("click", function(){
  const name = document.getElementById("lokasiNama").value.trim();
  const embed = document.getElementById("lokasiEmbed").value.trim();
  if(!name || !embed){ alert("Nama lokasi dan embed/link wajib diisi."); return; }

  const arr = getMaps();
  if(editingId) {
    const idx = arr.findIndex(x=>x.id===editingId);
    if(idx !== -1) {
      arr[idx].name = name; arr[idx].embed = embed; arr[idx].updated = Date.now();
    } else {
      arr.push({ id: editingId, name, embed, created: Date.now() });
    }
    editingId = null;
  } else {
    arr.push({ id: uid(), name, embed, created: Date.now() });
  }
  saveMaps(arr);
  clearForm();
  renderList();
  alert("Data lokasi berhasil disimpan.");
});

document.getElementById("btnBersihkan").addEventListener("click", clearForm);

function clearForm(){
  editingId = null;
  document.getElementById("lokasiNama").value = "";
  document.getElementById("lokasiEmbed").value = "";
  const preview = document.getElementById("previewArea");
  preview.innerHTML = '<small class="text-muted">Tidak ada preview</small>';
}

/* edit */
function editItem(id){
  const arr = getMaps();
  const item = arr.find(x=>x.id===id);
  if(!item) return alert("Item tidak ditemukan.");
  editingId = id;
  document.getElementById("lokasiNama").value = item.name;
  document.getElementById("lokasiEmbed").value = item.embed;
  renderPreview(item.embed);
  window.scrollTo({top:0, behavior:"smooth"});
}

/* hapus */
function hapusItem(id){
  if(!confirm("Hapus lokasi ini?")) return;
  let arr = getMaps().filter(x=>x.id!==id);
  saveMaps(arr);
  renderList();
}

/* useOnPublic: sets a key 'afnalink_map_active' to the id which public script can use to show default map */
function useOnPublic(id){
  localStorage.setItem("afnalink_map_active", id);
  alert("Lokasi ini akan tampil sebagai default pada halaman publik (jika publik menggunakan fitur default).");
}

/* preview area dynamic */
document.getElementById("lokasiEmbed").addEventListener("input", function(e){
  renderPreview(e.target.value);
});

function renderPreview(text){
  const preview = document.getElementById("previewArea");
  if(!text.trim()){
    preview.innerHTML = '<small class="text-muted">Tidak ada preview</small>'; return;
  }

  // If iframe already provided, embed as-is (but sanitized: remove script tags)
  if(/<iframe/i.test(text)){
    // Allow only iframe tag: strip scripts
    const cleaned = text.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
    preview.innerHTML = cleaned;
    return;
  }

  // If it's a URL -> create iframe from URL (Google Maps format)
  if(/^https?:\/\//i.test(text)){
    // Try to create embeddable URL: if containing '/maps', use it directly in iframe src
    let src = text;
    // If it's a share URL (short), still use it as src
    preview.innerHTML = `<iframe src="${escapeAttr(src)}" style="width:100%;height:100%;border:0;" allowfullscreen="" loading="lazy"></iframe>`;
    return;
  }

  preview.innerHTML = '<small class="text-danger">Format tidak dikenali (gunakan iframe atau URL)</small>';
}

/* export/import JSON */
document.getElementById("btnExport").addEventListener("click", function(){
  const data = getMaps();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "afnalink_maps_export.json"; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("btnImport").addEventListener("click", function(){
  document.getElementById("fileImport").click();
});
document.getElementById("fileImport").addEventListener("change", function(e){
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try {
      const parsed = JSON.parse(evt.target.result);
      if(!Array.isArray(parsed)) throw new Error("Format JSON salah");
      saveMaps(parsed);
      renderList();
      alert("Import berhasil.");
    } catch(err){
      alert("Gagal import: " + err.message);
    }
  };
  reader.readAsText(f);
});

/* helpers */
function escapeAttr(s){ return (s||'').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

/* delete all (dev helper) - uncomment to use
function clearAll(){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
*/

renderList();

/* On load, show preview if afnalink_map_active exists */
(function autoPreviewActive(){
  const active = localStorage.getItem("afnalink_map_active");
  if(active){
    const arr = getMaps();
    const item = arr.find(x=>x.id===active);
    if(item) renderPreview(item.embed);
  }
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
